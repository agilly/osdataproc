#!/bin/bash

OSDP=$(readlink -f "$0")
OSDP_HOME=$(dirname "$OSDP")

export TF_VAR_os_user_name=$OS_USERNAME
export TF_VAR_os_tenant_name=$OS_PROJECT_NAME
export TF_VAR_os_password=$OS_PASSWORD
export TF_VAR_os_auth_url=$OS_AUTH_URL
export TF_VAR_os_region_name=$OS_REGION_NAME
export TF_VAR_os_interface=$OS_INTERFACE

export TF_VAR_cluster_name=$2
if [[ $3 =~ ^[0-9]+$ ]] ; then
	export TF_VAR_slaves=$(($3))
fi
if [[ $4 == "None" ]] ; then
	echo "default flavor chosen"
else
	export TF_VAR_flavor_name=$4
fi
export TF_VAR_spark_keypair=$5
if [[ -f $6 ]] ; then
	export TF_VAR_identity_file=$(< $6)
elif [[ $6 == "None" ]] ; then
	echo $6
fi

ansible () {
        export ANSIBLE_HOST_KEY_CHECKING=False
        ansible-playbook -i ${OSDP_HOME}/terraform/terraform.tfstate.d/${TF_VAR_cluster_name}/hosts_$1 ${OSDP_HOME}/ansible/main.yml -e 'ansible_python_interpreter=/usr/bin/python3' > ${OSDP_HOME}/terraform/terraform.tfstate.d/${TF_VAR_cluster_name}/ansible-$1.log 2>&1
}

case $1 in
	init)
		cd ${OSDP_HOME}/terraform && terraform init -input=false
		;;
	apply)
		cd ${OSDP_HOME}/terraform
	       	terraform workspace \select $2 || terraform workspace new $2
	        terraform plan -out="terraform.tfstate.d/$2/plan" -input=false
		terraform apply -input=false "terraform.tfstate.d/$2/plan"
		terraform output -json > outputs.json
		ansible "master" & 
		ansible "slaves" &
		exit 0
		;;
	destroy)
		cd ${OSDP_HOME}/terraform
	        if ! terraform workspace \select $2 ; then
			echo "cluster not found"
		else
			terraform workspace \select $2 && \
			terraform destroy && \
			terraform workspace \select default && \
			terraform workspace delete $2
		fi
		exit 0
		;;
	#update)
	#	cd ${OSDP_HOME}/terraform
	#	terraform workspace \select $2 
	#	echo $3
	#	#echo "variable "slaves" { default = ${3} } " > override.tf
	#	cp variables.tf terraform.tfstate.d/$2/
	#	terraform refresh -var "slaves=$3" terraform.tfstate.d/$2/
		#terraform apply -input=false "$2-plan"
	#	rm override.tf
	#	exit 0
	#	;;
	*)
		exit 0
		;;
esac
